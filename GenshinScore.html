<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åŸç¥ è–éºç‰©ã‚¹ã‚³ã‚¢ãƒã‚§ãƒƒã‚«ãƒ¼</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background: linear-gradient(180deg, #1e1b2e, #2a2550);
      color: #fff;
      margin: 0;
      padding: 16px;
    }
    h1 {
      font-size: 1.3rem;
      text-align: center;
    }
    .box {
      max-width: 520px;
      margin: auto;
      background: #2f2a55;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.3);
    }
    input, button {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      border-radius: 10px;
      border: none;
      margin-top: 8px;
    }
    input {
      background: #1f1c3a;
      color: #fff;
    }
    button {
      background: #ffcc66;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      opacity: .9;
    }
    pre {
      white-space: pre-wrap;
      word-break: break-all;
      background: #1a1730;
      padding: 12px;
      border-radius: 12px;
      margin-top: 12px;
      font-size: .85rem;
    }
  </style>
</head>
<body>

  <h1>ğŸŒŸ åŸç¥ è–éºç‰©ã‚¹ã‚³ã‚¢ãƒã‚§ãƒƒã‚«ãƒ¼</h1>

  <div class="box">
    <label>UID</label>
    <input id="uid" type="number" placeholder="UIDã‚’å…¥åŠ›" />

    <button onclick="loadData()">å–å¾—</button>

    <div id="output"></div>
  </div>

<script>
/* ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼šURLã« uid ãŒã‚ã‚Œã°å…¥åŠ›æ¬„ã«å…¥ã‚Œã‚‹ã ã‘ */
(() => {
  const params = new URLSearchParams(location.search);
  const savedUid = params.get("uid");
  if (savedUid) {
    document.getElementById("uid").value = savedUid;
  }
})();

/* â˜… å…¥åŠ›æ¬„ã®UIDã‚’å¿…ãšä½¿ã† â˜… */
async function loadData() {
  const uidInput = document.getElementById("uid").value.trim();
  const out = document.getElementById("output");

  if (!uidInput) {
    alert("UIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const uid = uidInput; // â† ã“ã“ãŒæœ€å„ªå…ˆ

  // URLã«ä¿å­˜ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
  history.replaceState(null, "", `?uid=${uid}`);

  out.textContent = "å–å¾—ä¸­â€¦";

  try {
    const res = await fetch(`https://enka.network/api/uid/${uid}`);
    if (!res.ok) {
      out.textContent = "Enka API ã‚¨ãƒ©ãƒ¼";
      return;
    }

    const data = await res.json();

    if (!data.avatarInfoList) {
      out.textContent = "å–å¾—å¤±æ•—ï¼ˆã‚­ãƒ£ãƒ©è©³ç´°å…¬é–‹ã‚’ç¢ºèªï¼‰";
      return;
    }

    /* ã¾ãšã¯ç”Ÿãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºï¼ˆå‹•ä½œç¢ºèªç”¨ï¼‰ */
    out.innerHTML = `
      <p>âœ… å–å¾—æˆåŠŸ</p>
      <p>ã‚­ãƒ£ãƒ©æ•°ï¼š${data.avatarInfoList.length}</p>
      <pre>${JSON.stringify(data.avatarInfoList[0], null, 2)}</pre>
    `;

  } catch (e) {
    console.error(e);
    out.textContent = "é€šä¿¡å¤±æ•—";
  }
}
</script>

</body>
</html>  out.textContent = "å–å¾—ä¸­â€¦";

  try {
    await loadCharMeta();
    const res = await fetch(`https://enka.network/api/uid/${uid}`);
    const data = await res.json();
    out.innerHTML = "";

    for (const char of data.avatarInfoList) {
      const meta = CHAR_META[char.avatarId];
      const name = meta?.name || "ä¸æ˜ã‚­ãƒ£ãƒ©";
      const ref = getRefStat(char.avatarId);

      let total = 0;
      let expectSum = 0;
      let count = 0;

      let html = `<div class="card">
        <div class="char">${name}ï¼ˆå‚ç…§:${ref}ï¼‰</div>`;

      for (const e of char.equipList.filter(x => x.reliquary)) {
        const r = calcScore(e.reliquary.substats || [], ref);
        total += r.score;
        expectSum += r.expect;
        count++;

        const judge =
          r.score >= 40 ? "ğŸŒŸ ç¥" :
          r.score >= 30 ? "ğŸ‘ å¦¥å”" : "âš  å¾®å¦™";

        const dev = ((r.score - 30) + 50).toFixed(1);

        html += `
        <div class="art" style="color:${scoreColor(r.score)}">
          ã‚¹ã‚³ã‚¢ ${r.score.toFixed(1)} ï½œ åå·®å€¤ ${dev}<br>
          æœŸå¾…å€¤ ${r.expect.toFixed(1)} ï½œ ğŸ”¥è¤‡åˆ ${r.hybrid.toFixed(1)}
          ï½œ ${judge}
        </div>`;
      }

      html += `
        <div class="total">
          åˆè¨ˆã‚¹ã‚³ã‚¢ ${total.toFixed(1)}<br>
          å¹³å‡æœŸå¾…å€¤ ${(expectSum / count).toFixed(1)}
        </div>
      </div>`;

      out.innerHTML += html;
    }
  } catch {
    out.textContent = "å–å¾—å¤±æ•—ï¼ˆã‚­ãƒ£ãƒ©è©³ç´°å…¬é–‹ã‚’ç¢ºèªï¼‰";
  }
}

function calcScore(substats, ref) {
  let score = 0, cr = 0, cd = 0, refPct = 0;

  for (const s of substats) {
    const v = s.statValue;
    if (s.appendPropId === "FIGHT_PROP_CRITICAL") {
      score += v * 2; cr += v;
    } else if (s.appendPropId === "FIGHT_PROP_CRITICAL_HURT") {
      score += v; cd += v;
    } else if (ref === "ATK" && s.appendPropId === "FIGHT_PROP_ATTACK_PERCENT") {
      score += v; refPct += v;
    } else if (ref === "HP" && s.appendPropId === "FIGHT_PROP_HP_PERCENT") {
      score += v; refPct += v;
    } else if (ref === "DEF" && s.appendPropId === "FIGHT_PROP_DEFENSE_PERCENT") {
      score += v; refPct += v;
    }
  }

  const expect = cr * cd;
  const hybrid = expect * (1 + refPct / 100);
  return { score, expect, hybrid };
}
</script>
</body>
</html>
