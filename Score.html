<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Genshin Build Analyzer</title>

<style>
:root {
  --bg:#020617;
  --card:rgba(30,41,59,.85);
  --text:#e5e7eb;
  --sub:#94a3b8;
  --gold:#facc15;
  --accent:#38bdf8;
}

body {
  margin:0;
  background:linear-gradient(180deg,#020617,#0f172a);
  color:var(--text);
  font-family:system-ui,-apple-system;
}

header {
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

input {
  background:var(--card);
  border:none;
  border-radius:12px;
  padding:8px 12px;
  color:var(--text);
}

.card {
  background:var(--card);
  margin:12px;
  padding:16px;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.4);
}

.char-header {
  display:flex;
  gap:12px;
  align-items:center;
}

.char-icon {
  width:56px;
  height:56px;
  border-radius:12px;
  background:#1e293b;
}

.rank {
  font-size:32px;
  font-weight:900;
}

.rank.S { color:#facc15 }
.rank.A { color:#60a5fa }
.rank.B { color:#a3e635 }
.rank.C { color:#f87171 }

.score {
  font-size:22px;
  font-weight:700;
  margin-left:8px;
}

.footer {
  margin-top:40px;
  padding:28px 12px 36px;
  font-size:12px;
  text-align:center;
  color:var(--sub);
}
</style>
</head>

<body>

<header>
  <div>原神ビルド解析</div>
  <input id="uidInput" placeholder="UID入力" maxlength="9" />
</header>

<div id="characterList"></div>

<footer class="footer">
  非公式 原神ビルド解析ツール<br>
  Enka.Network API / miHoYo TextMap 使用<br>
  作者: @Chloe<br>
  Genshin Impact © COGNOSPHERE / HoYoverse
</footer>

<script>
/* =========================
  聖遺物スコア計算
========================= */
/*
  基準：
  会心率 ×2
  会心ダメ ×1
  攻撃% / HP% / 防御% ×1
  元素チャージ ×1
*/
function calcArtifactScore(artifact) {
  let score = 0;

  artifact.flat.reliquarySubstats?.forEach(sub => {
    const v = sub.statValue;
    switch (sub.appendPropId) {
      case "FIGHT_PROP_CRITICAL":
        score += v * 2;
        break;
      case "FIGHT_PROP_CRITICAL_HURT":
        score += v;
        break;
      case "FIGHT_PROP_ATTACK_PERCENT":
      case "FIGHT_PROP_HP_PERCENT":
      case "FIGHT_PROP_DEFENSE_PERCENT":
      case "FIGHT_PROP_CHARGE_EFFICIENCY":
        score += v;
        break;
    }
  });

  return score;
}

/* =========================
  キャラスコア算出
========================= */
function calcCharacterScore(char) {
  let total = 0;
  let count = 0;

  char.equipList.forEach(equip => {
    if (equip.flat?.itemType === "ITEM_RELIQUARY") {
      total += calcArtifactScore(equip);
      count++;
    }
  });

  const avg = count ? total / count : 0;
  return avg;
}

function rankFromScore(score) {
  if (score >= 40) return "S";
  if (score >= 30) return "A";
  if (score >= 20) return "B";
  return "C";
}

/* =========================
  Enka取得
========================= */
async function fetchEnka(uid) {
  const res = await fetch(`https://enka.network/api/uid/${uid}`);
  if (!res.ok) return null;
  return await res.json();
}

/* =========================
  描画
========================= */
function renderCharacters(data) {
  const list = document.getElementById("characterList");
  list.innerHTML = "";

  if (!data.avatarInfoList) {
    list.innerHTML = "<div class='card'>キャラ詳細が非公開です</div>";
    return;
  }

  data.avatarInfoList.forEach(char => {
    const score = calcCharacterScore(char);
    const rank = rankFromScore(score);

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="char-header">
        <div class="char-icon"></div>
        <div>
          <div>Avatar ID: ${char.avatarId}</div>
          <div>Lv.${char.propMap["4001"].val}</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <span class="rank ${rank}">${rank}</span>
        <span class="score">${score.toFixed(1)}</span>
      </div>
    `;

    list.appendChild(card);
  });
}

/* =========================
  UID入力
========================= */
document.getElementById("uidInput")
  .addEventListener("change", async e => {
    const uid = e.target.value.trim();
    if (!uid) return;

    const data = await fetchEnka(uid);
    if (!data) {
      alert("取得できませんでした");
      return;
    }

    renderCharacters(data);
  });
</script>

</body>
</html>
