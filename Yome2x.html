<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Yome2x Web版（キャンセル対応）</title>
<style>
body { font-family: sans-serif; text-align: center; margin: 20px; }
canvas { border: 1px solid #ccc; margin: 10px; max-width: 90vw; height: auto; display: block; margin-left:auto; margin-right:auto; }
button { padding: 10px 20px; margin: 5px; }
.progress-container { width: 80%; background: #eee; margin: 10px auto; height: 20px; border-radius: 10px; overflow: hidden; position: relative; }
.progress-bar { height: 100%; width: 0%; background: #4caf50; transition: width 0.3s; }
.progress-text { position: absolute; width: 100%; text-align: center; top: 0; line-height: 20px; font-size: 12px; color: #000; }
label { margin: 0 10px; }
</style>
</head>
<body>

<h1>Yome2x Web版（キャンセル対応）</h1>

<input type="file" id="imageInput" accept="image/*" multiple><br><br>

<label>目標拡大倍率:
<select id="scaleSelect">
<option value="1">1倍</option>
<option value="2" selected>2倍</option>
<option value="4">4倍</option>
<option value="8">8倍</option>
</select>
</label>

<label>ノイズレベル:
<select id="noiseSelect">
<option value="0">0</option>
<option value="1" selected>1</option>
<option value="2">2</option>
</select>
</label><br><br>

<div class="progress-container">
  <div class="progress-bar" id="progressBar"></div>
  <div class="progress-text" id="progressText"></div>
</div>
<button id="enhanceBtn">高画質化 & ZIP ダウンロード</button>
<button id="cancelBtn">キャンセル</button>

<div id="canvasContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@xintao/real-esrgan-js@1.0.0/dist/real-esrgan.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.11.0/dist/jszip.min.js"></script>

<script>
const imageInput = document.getElementById('imageInput');
const enhanceBtn = document.getElementById('enhanceBtn');
const cancelBtn = document.getElementById('cancelBtn');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const canvasContainer = document.getElementById('canvasContainer');
const scaleSelect = document.getElementById('scaleSelect');
const noiseSelect = document.getElementById('noiseSelect');

let imageBitmaps = [];
let cancelFlag = false;
let currentWorker = null;

// 画像選択
imageInput.addEventListener('change', async (e) => {
  canvasContainer.innerHTML = "";
  imageBitmaps = [];
  const files = Array.from(e.target.files);

  for (let file of files) {
    const img = await createImageBitmap(file);
    const MAX_WIDTH = 1024;
    const MAX_HEIGHT = 1024;
    let width = img.width;
    let height = img.height;
    if(width > MAX_WIDTH || height > MAX_HEIGHT){
      const ratio = Math.min(MAX_WIDTH/width, MAX_HEIGHT/height);
      width = Math.round(width*ratio);
      height = Math.round(height*ratio);
    }
    const canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, width, height);
    const bitmap = ctx.getImageData(0,0,width,height);
    imageBitmaps.push({ bitmap: bitmap, name: file.name });

    const displayCanvas = document.createElement('canvas');
    displayCanvas.width = width;
    displayCanvas.height = height;
    displayCanvas.getContext('2d').putImageData(bitmap,0,0);
    canvasContainer.appendChild(displayCanvas);
  }
});

// Web Worker用Blob
const workerBlob = new Blob([`
importScripts('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js');
importScripts('https://cdn.jsdelivr.net/npm/@xintao/real-esrgan-js@1.0.0/dist/real-esrgan.min.js');
onmessage = async (e) => {
  let { bitmap, noise, steps } = e.data;
  for(let i=0;i<steps;i++){
    bitmap = await RealESRGAN.enhance(bitmap, {scale:2, noise:parseInt(noise)});
    postMessage({ enhanced: bitmap, step: i+1 });
  }
};
`], {type:'application/javascript'});
const workerURL = URL.createObjectURL(workerBlob);

// キャンセルボタン
cancelBtn.addEventListener('click', () => {
  cancelFlag = true;
  if(currentWorker) currentWorker.terminate();
  progressText.innerText = "キャンセルされました";
  enhanceBtn.disabled = false;
});

// 高画質化 & ZIP
enhanceBtn.addEventListener('click', async () => {
  if(!imageBitmaps.length) return;
  enhanceBtn.disabled = true;
  cancelFlag = false;
  progressBar.style.width = "0%";
  progressText.innerText = "";

  const zip = new JSZip();
  const targetScale = parseInt(scaleSelect.value);
  const noise = parseInt(noiseSelect.value);
  const steps = targetScale > 1 ? Math.log2(targetScale) : 1;

  for(let i=0;i<imageBitmaps.length;i++){
    if(cancelFlag) break;
    const imgData = imageBitmaps[i];
    const enhancedCanvas = document.createElement('canvas');
    const ctx = enhancedCanvas.getContext('2d');
    canvasContainer.appendChild(enhancedCanvas);

    currentWorker = new Worker(workerURL);
    await new Promise((resolve)=>{
      let currentStep = 0;
      currentWorker.onmessage = (event)=>{
        if(cancelFlag){
          currentWorker.terminate();
          resolve();
          return;
        }
        const enhanced = event.data.enhanced;
        currentStep = event.data.step;
        enhancedCanvas.width = enhanced.width;
        enhancedCanvas.height = enhanced.height;
        ctx.putImageData(enhanced,0,0);
        progressText.innerText = `処理中: ${imgData.name} (段階 ${currentStep}/${steps})`;
        if(currentStep === steps) resolve();
      };
      currentWorker.postMessage({ bitmap: imgData.bitmap, steps: steps, noise: noise });
    });
    currentWorker.terminate();
    currentWorker = null;

    if(cancelFlag) break;

    const dataURL = enhancedCanvas.toDataURL("image/png");
    const base64 = dataURL.split(",")[1];
    zip.file(`enhanced_${imgData.name}.png`, base64, {base64:true});

    progressBar.style.width = `${((i+1)/imageBitmaps.length)*100}%`;
  }

  if(!cancelFlag){
    progressText.innerText = "処理完了！";
    const content = await zip.generateAsync({type:"blob"});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(content);
    link.download = "enhanced_images.zip";
    link.click();
  }
  enhanceBtn.disabled = false;
});
</script>

</body>
</html>